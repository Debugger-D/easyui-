<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>评论审核</title>
<link rel="stylesheet" type="text/css" href="/fdj/css/my_easyui.css">
<link rel="stylesheet" type="text/css" href="/fdj/css/icon.css">
<link rel="stylesheet" href="/fdj/css/ui-dialog.css">
<style>

@CHARSET "UTF-8";
/*common.css*/
body,button,input,select,textarea{font:12px/1.5 arial,'Hiragino Sans GB','微软雅黑','宋体',tahoma,Srial,helvetica,sans-serif;-webkit-font-smoothing:antialiased;}
body,h1,h2,h3,h4,h5,h6,hr,p,blockquote,dl,dt,dd,ul,ol,li,pre,form,fieldset,legend,button,input,textarea,th,td,img{font-weight:400;outline:0;border:medium none;margin:0;padding:0;list-style:none;}

</style>
<script src="http://libs.baidu.com/jquery/2.1.4/jquery.js"></script>
<script src="/fdj/js/jquery.easyui.min.js"></script>
<script src="/fdj/js/easyui-lang-zh_CN.js"></script>
<script src="/fdj/js/yuelj.js"></script>
<script src="/fdj/js/dialog-min.js"></script>
<script type="text/javascript">
//评论列表
var commList = [];

//分页参数
var pageJson = {
	pageNum : 1,
	pageSize : 20,
	totalCount : 0
};
//传入后台查询用户的参数
var entityJson = {
	topictype : "1",
	state : "0"
};
var postData ={};
postData.pageJson = JSON.stringify(pageJson);
postData.entityJson = JSON.stringify(entityJson);

var openWin = {};
openWin.state = false;

$(function() {
	$.yuelj.checkPermission("operator");
	//用户列表
	$('#dg').datagrid({
		loadMsg : '数据加载中,请稍后...',
		singleSelect : true,
		height : 750,
		pagination : true,
		pageList : [ 20, 40, 80 ],
		pageSize : 20,
		columns : [ [ {
			field : 'id',
			title : '评论id',
			hidden : true
		},{
			field : 'topicid',
			title : '评论人id',
			hidden : true
		},{
			field : 'userid',
			title : '评论人id',
			hidden : true
		},{
			field : 'username',
			title : '用户名',
			width : 80,
			align : 'center'
		},{
			field : 'phone',
			title : '手机号',
			width : 100,
			align : 'center'
		},{
			field : 'star',
			title : '星级',
			width : 50,
			align : 'center'
		},{
			field : 'content',
			title : '评论内容',
			width : 400
		},{
			field : 'type',
			title : '类型',
			width : 60,
			formatter : formatType,
			align : 'center'
		}, {
			field : 'pic',
			title : '图片id',
			width : 60,
			align : 'center'
		}, {
			field : 'voice',
			title : '语音id',
			width : 60,
			align : 'center'
		},{
			field : 'createtime',
			title : '评论时间',
			width : 150,
			align : 'center'
		}, {
			field : 'state',
			title : '状态',
			width : 80,
			formatter : formatState,
			align : 'center'
		}, {
			field : 'istop',
			title : '是否置精',
			width : 60,
			formatter : formatIstop,
			align : 'center'
		}, {
			field : 'topictype',
			title : '话题类型',
			width : 80,
			formatter : formatTopictype,
			align : 'center'
		}, {
			field : 'topicname',
			title : '话题名',
			width : 100,
			align : 'center'
		}, {
			field : 'innname',
			title : '客栈',
			width : 100,
			align : 'center'
		}, {
			field : 'spotname',
			title : '景点',
			width : 100,
			align : 'center'
		}, {
			field : 'travelname',
			title : '游记',
			width : 100,
			align : 'center'
		}, {
			field : 'checkuser',
			title : '审核人',
			width : 50,
			align : 'center'
		}, {
			field : 'checktime',
			title : '审核时间',
			width : 150,
			align : 'center'
		} ] ],
		toolbar : [{
			iconCls : 'icon-search',
			text : '查看评论',
			handler : function() {
				if (openWin.state) {
					return;
				}
				openWin.state = true;

				var row = $('#dg').datagrid("getSelected");
				if (row != null && row.id != null) {
					openWin.obj = row;
					loadWin(row.id);
				}
			}
		}, '-', {
			iconCls : 'icon-edit',
			text : '审核通过',
			handler : function() {
				approveCommClick(1);
			}
		}, '-', {
			iconCls : 'icon-clear',
			text : '审核不通过',
			handler : function() {
				approveCommClick(2);
			}
		}, '-', {
			iconCls : 'icon-ok',
			text : '设为精华',
			handler : function() {
				commIstopClick(1);
			}
		}, '-', {
			iconCls : 'icon-clear',
			text : '取消精华',
			handler : function() {
				commIstopClick(0);
			}
		} ],
		onDblClickRow: function(rowIndex) {
			 $('#dg').datagrid('selectRow',rowIndex);
			 if (openWin.state) {return;}
			openWin.state = true;

			var row = $('#dg').datagrid("getSelected");
			if (row != null && row.id != null) {
				openWin.obj = row;
				loadWin(row.id);
			}
		}
	});
	//评论窗体
	$('#win').window({
		width : 600,
		modal : false,
		title : "评论信息",
		resizable : true,
		onClose : function() {
			openWin = {};
			openWin.state = false;
		}
	});
	$('#win').window('close');

	loadDataGrid();
});
var from = 0;
var to = 0;
//加载分页条
function initPagination() {
	$('#dg').datagrid("getPager").pagination(
			{
				total : pageJson.totalCount,
				pageSize : pageJson.pageSize,
				pageNumber : parseInt(pageJson.pageNum),
				onSelectPage : function(pageNum, pageSize) {
					$(this).pagination('loading');
					pageJson.pageSize = pageSize;
					pageJson.pageNum = pageNum;
					postData.pageJson = JSON.stringify(pageJson);

					loadDataGrid();
					$(this).pagination('loaded');
				},
				displayMsg : '当前显示' + from + "到" + to + '条记录   共'
						+ pageJson.totalCount + ' 条记录'
			});

}
//加载评论列表
function loadDataGrid() {
	//0未审核，1有效，2审核不通过
	$.ajax({
		url : "/fdj/operator/appCommentListForOperator.action",
		data : postData,
		success : function(returnData) {
			if (returnData == null || returnData.list == null) {
				$.yuelj.alertMessage('提示', '获取失败!');
			} else {
				$('#dg').datagrid("loadData", {
					"rows" : returnData.list
				});
				if (returnData.list.length != 0) {
					$('#dg').datagrid("selectRow", 0);
				}
				pageJson.totalCount = returnData.page.totalCount;
				returnData.page.totalCount == 0 ? from = 0 : from = returnData.page.ifrom + 1;
				to = pageJson.pageSize * pageJson.pageNum;
				if (to > pageJson.totalCount) {
					to = pageJson.totalCount;
				}
				pageJson.pageSize = returnData.page.pageSize;
				pageJson.pageNum = returnData.page.pageNum;

				initPagination();
			}

		}
	});
}

//格式化表格数据
function formatType(val,row){
	switch(val){
	case "1":
		return '文字';
	case "2":
		return "图片";
	case "3":
		return '语音';
	}
}

function formatState(val,row){
	switch(val){
	case "0":
		return '<span style="background-color:#007988;color:#fff">等待审核</span>';
	case "1":
		return "审核通过";
	case "2":
		return '<span style="background-color:red;color:#fff">审核不通过</span>';
	}
}

function formatIstop(val,row){
	switch(val){
	case "0":
		return '';
	case "1":
		return "精华帖";
	}
}

function formatTopictype(val,row){
	switch(val){
	case "1":
		return "客栈";
	case "2":
		return "景点";
	case "3":
		return "游记";
	}
}

//查询按钮点击
function searchButtonClick() {
	var entityJson = {};
	pageJson = {
		pageNum : 1,
		pageSize : 20,
		totalCount : 0
	};

	postData.pageJson = JSON.stringify(pageJson);
	var state = $("#searchState").textbox('getValue');
	var topictype = $("#searchTopicType").textbox('getValue');
	if (state != null && state.length != 0) {
		entityJson.state = state;
	}
	if (topictype != null && topictype.length != 0) {
		entityJson.topictype = topictype;
		switch(topictype){
		case "1":
			$('#dg').datagrid('showColumn','innname');
			$('#dg').datagrid('hideColumn','spotname');
			$('#dg').datagrid('hideColumn','travelname');
			break;
		case "2":
			$('#dg').datagrid('showColumn','spotname');
			$('#dg').datagrid('hideColumn','innname');
			$('#dg').datagrid('hideColumn','travelname');
			break;
		case "3":
			$('#dg').datagrid('showColumn','travelname');
			$('#dg').datagrid('hideColumn','innname');
			$('#dg').datagrid('hideColumn','spotname');
			break;
		}
	}
	postData.entityJson = JSON.stringify(entityJson);
	$('#dg').datagrid('loadData', { total: 0, rows: [] });
	loadDataGrid();
}

//评论审核
function approveCommClick(CommState) {

	$('#win').window('close');
	//获取选中
	var row = $('#dg').datagrid('getSelected');
	var newrow = {};
	if (row != null) {
		newrow.id = row.id;
		newrow.state = CommState;
		//newrow.checktime = $.yuelj.getDateTimeStr(new Date());
		$.ajax({
			url : "/fdj/operator/auditAppComment.action",
			data : {
				entityJson : JSON.stringify(newrow)
			},
			success : function(returnData) {
				if ($.yuelj.parseReturn(returnData)) {
					$.yuelj.alertMessage('提示', "操作成功");
					loadDataGrid();
				}
			}
		});
	}
}

//评论设置精华
function commIstopClick(istop) {

	$('#win').window('close');
	//获取选中
	var row = $('#dg').datagrid('getSelected');
	var newrow = {};
	if (row != null) {
		newrow.id = row.id;
		newrow.istop = istop;
		$.ajax({
			url : "/fdj/operator/auditAppComment.action",
			data : {
				entityJson : JSON.stringify(newrow)
			},
			success : function(returnData) {
				if ($.yuelj.parseReturn(returnData)) {
					$.yuelj.alertMessage('提示', "操作成功");
					loadDataGrid();
				}
			}
		});
	}
}

//加载评论窗体
function loadWin() {
	$('#win').window('open');
	loadComm();

}

// 加载评论详情数据
function loadComm() {
	$('#win input').each(function() {
		var name = $(this).attr('id');
		if (name != null) {

			var value = openWin.obj[name];
			if (value != null && $("#" + name).textbox != null) {
				$("#" + name).textbox('setValue', value);
			}else{
				$("#" + name).textbox('setValue', value);
			}
		}
	});
	$("#content").text(openWin.obj["content"]);
	//如果有图片
	$("#pic").attr('src','').css({"width":"50px","height":"25px"});
	if(openWin.obj["pic"] != ""){
		$("#pic").attr('src',$.yuelj.imageurlPre + openWin.obj["pic"]).css({"width":"360px","height":"270px"});
	}

}
</script>
</head>
<body>
	<div id="div-content" style="padding:10px;">
		<div id="serachdiv">
			<!-- <input id="searchUserid" class="easyui-textbox" type="text" name="searchUserid"
				data-options="buttonText:'评论人ID',buttonAlign:'left'" /> -->
			<select id="searchTopicType" class="easyui-combobox"
				data-options="buttonText:'类型',buttonAlign:'left',editable:false" name="searchTopicType" style="width: 200px;">
				<option value="1">客栈评论</option>
				<option value="2">景点评论</option>
				<option value="3">游记评论</option>
			</select>
			<select id="searchState" class="easyui-combobox"
				data-options="buttonText:'状态',buttonAlign:'left',editable:false" name="searchState" style="width: 200px;">
				<option value="0">未审核</option>
				<option value="1">审核通过</option>
				<option value="2">审核不通过</option>
				<option value="">全部</option>
			</select>
			<a id="searchButton" href="javascipt:void(0)" onclick="searchButtonClick()" class="easyui-linkbutton" data-options="iconCls:'icon-search'">查询</a>
		</div>
		
		<table id="dg" class="easyui-datagrid"></table>
		
		<div id="win" style="text-align: center;">
			<div style="margin-top: 10px;">
				<input id="username" class="easyui-textbox"
					data-options="buttonText:'评论人',buttonAlign:'left',readonly:'ture'"> 
				<input id="topicname" class="easyui-textbox"
					data-options="buttonText:'话题名称',buttonAlign:'left',readonly:'ture'">
			</div>
			<label>评论内容</label><br />
			<textarea id="content" readonly = "readonly" 
				style="width:360px;height:180px;border:#e0e0e0 1px solid;padding:5px;"></textarea><br />
			<img id="pic" alt="无图" src=""><br />
			<input id="state" class="easyui-textbox"
				data-options="buttonText:'状态',buttonAlign:'left',readonly:'ture'">
			<label>0未审核，1有效，2审核不通过</label><br />
			<div style="margin:20px auto;">
				<a id="approve" href="javascript:void(0)" onclick="approveCommClick(1)" class="easyui-linkbutton" data-options="iconCls:'icon-edit'">审核通过</a>
				<a id="notApprove" href="javascript:void(0)" onclick="approveCommClick(2)" class="easyui-linkbutton" data-options="iconCls:'icon-clear'">审核不通过</a>
				<a id="istop" href="javascript:void(0)" onclick="commIstopClick(1)" class="easyui-linkbutton" data-options="iconCls:'icon-edit'">设为精华</a>
				<a id="nottop" href="javascript:void(0)" onclick="commIstopClick(0)" class="easyui-linkbutton" data-options="iconCls:'icon-clear'">取消精华</a>
			</div>
			
		</div>
	</div>
</body>
</html>